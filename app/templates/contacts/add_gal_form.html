<div class="modal-content gal-modal">
  <div class="modal-header">
    <h2>Add from Global Address List</h2>
    <button class="close-btn" hx-get="/contacts/close-modal" hx-target="#contact-modal">Ã—</button>
  </div>
  <form hx-post="/contacts/add/gal" hx-target="#contact-list">
    <div class="filter-controls">
      <select id="department-filter" onchange="filterGalUsers()">
        <option value="">All Departments</option>
        {% set departments = [] %} {% for user in users %} {% if user.department and user.department not in departments
        %} {% set _ = departments.append(user.department) %} {% endif %} {% endfor %} {% for dept in departments|sort %}
        <option value="{{ dept }}">{{ dept }}</option>
        {% endfor %}
      </select>

      <select id="title-filter" onchange="filterGalUsers()">
        <option value="">All Titles</option>
        {% set titles = [] %} {% for user in users %} {% if user.jobTitle and user.jobTitle not in titles %} {% set _ =
        titles.append(user.jobTitle) %} {% endif %} {% endfor %} {% for title in titles|sort %}
        <option value="{{ title }}">{{ title }}</option>
        {% endfor %}
      </select>

      <label class="checkbox-filter">
        <input type="checkbox" id="has-phone" onchange="filterGalUsers()" />
        Has Phone Number
      </label>

      <div class="selection-controls">
        <button type="button" class="btn-link" onclick="selectAllVisible()">Select All Visible</button>
        <button type="button" class="btn-link" onclick="unselectAll()">Unselect All</button>
      </div>
    </div>

    <div class="gal-list">
      {% for user in users %}
      <div
        class="gal-user-card"
        data-department="{{ user.department or '' }}"
        data-title="{{ user.jobTitle or '' }}"
        data-has-phone="{{ 'true' if user.businessPhones or user.mobilePhone else 'false' }}"
      >
        <div class="gal-user-select">
          <input type="checkbox" id="user-{{ user.id }}" name="user_ids" value="{{ user.id }}" />
        </div>
        <div class="gal-user-info">
          <label for="user-{{ user.id }}" class="gal-user-name">{{ user.displayName }}</label>
          <div class="gal-user-details">
            {% if user.jobTitle %}
            <div class="detail"><span class="label">Title:</span> {{ user.jobTitle }}</div>
            {% endif %} {% if user.department %}
            <div class="detail"><span class="label">Department:</span> {{ user.department }}</div>
            {% endif %} {% if user.businessPhones %}
            <div class="detail"><span class="label">Business:</span> {{ user.businessPhones[0] }}</div>
            {% endif %} {% if user.mobilePhone %}
            <div class="detail"><span class="label">Mobile:</span> {{ user.mobilePhone }}</div>
            {% endif %} {% if user.officeLocation %}
            <div class="detail"><span class="label">Office:</span> {{ user.officeLocation }}</div>
            {% endif %}
            <div class="detail"><span class="label">Email:</span> {{ user.userPrincipalName }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="form-actions">
      <button
        type="button"
        class="btn-secondary"
        onclick="document.getElementById('contact-modal').classList.remove('show')"
      >
        Cancel
      </button>
      <button type="submit" class="btn-primary">Add Selected Contacts</button>
    </div>
  </form>
</div>

<script>
  document.getElementById("contact-modal").classList.add("show");

  function toggleAllUsers() {
    const selectAll = document.getElementById("select-all");
    document.querySelectorAll(".user-checkbox").forEach((checkbox) => {
      const item = checkbox.closest(".gal-item");
      if (item.style.display !== "none") {
        // Only toggle visible items
        checkbox.checked = selectAll.checked;
      }
    });
  }

  function addSelectedUsers() {
    const selectedUsers = Array.from(document.querySelectorAll(".user-checkbox:checked")).map((cb) => cb.value);

    if (selectedUsers.length === 0) {
      logOutput("No users selected");
      return;
    }

    logOutput(`Adding ${selectedUsers.length} users from GAL...`);

    htmx.ajax("POST", "/contacts/add/gal", {
      target: "#contact-list",
      swap: "beforeend",
      values: { user_ids: selectedUsers },
    });
  }

  function applyFilters() {
    const titleFilter = document.getElementById("title-filter").value.toLowerCase();
    const departmentFilter = document.getElementById("department-filter").value.toLowerCase();
    const officeFilter = document.getElementById("office-filter").value.toLowerCase();
    const phoneFilter = document.getElementById("phone-filter").value;

    document.querySelectorAll(".gal-item").forEach((item) => {
      const title = item.dataset.title || "";
      const department = item.dataset.department || "";
      const office = item.dataset.office || "";
      const hasPhone = item.dataset.hasPhone === "true";

      const matchesTitle = !titleFilter || title.includes(titleFilter);
      const matchesDepartment = !departmentFilter || department.includes(departmentFilter);
      const matchesOffice = !officeFilter || office.includes(officeFilter);
      const matchesPhone =
        phoneFilter === "any" || (phoneFilter === "has" && hasPhone) || (phoneFilter === "none" && !hasPhone);

      item.style.display = matchesTitle && matchesDepartment && matchesOffice && matchesPhone ? "block" : "none";
    });

    // Uncheck "select all" when filters change
    document.getElementById("select-all").checked = false;
  }

  function filterGalUsers() {
    const departmentFilter = document.getElementById("department-filter").value;
    const titleFilter = document.getElementById("title-filter").value;
    const hasPhoneFilter = document.getElementById("has-phone").checked;

    document.querySelectorAll(".gal-user-card").forEach((card) => {
      const department = card.dataset.department;
      const title = card.dataset.title;
      const hasPhone = card.dataset.hasPhone === "true";

      const matchesDepartment = !departmentFilter || department === departmentFilter;
      const matchesTitle = !titleFilter || title === titleFilter;
      const matchesPhone = !hasPhoneFilter || hasPhone;

      card.style.display = matchesDepartment && matchesTitle && matchesPhone ? "flex" : "none";
    });
  }

  function selectAllVisible() {
    document.querySelectorAll(".gal-user-card").forEach((card) => {
      if (card.style.display !== "none") {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = true;
      }
    });
  }

  function unselectAll() {
    document.querySelectorAll('.gal-user-card input[type="checkbox"]').forEach((checkbox) => {
      checkbox.checked = false;
    });
  }
</script>

<style>
  .filter-section {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    background: white;
  }

  .filter-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
  }

  .filter-input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .gal-controls {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid #eee;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
  }

  .gal-list {
    max-height: 60vh;
    overflow-y: auto;
    padding: 1rem;
  }

  .gal-item {
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  .user-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .user-title,
  .user-department,
  .user-office {
    color: #666;
    font-size: 0.9em;
  }

  .user-phone,
  .user-mobile {
    color: #666;
    font-size: 0.9em;
  }
</style>
